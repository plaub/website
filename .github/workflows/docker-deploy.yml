name: Astro Docker CI/CD Pipeline

on:
  # Trigger: Allows manual execution from the GitHub Actions tab
  workflow_dispatch:

jobs:
  # ------------------------------------------------
  # JOB 1: Continuous Integration (CI)
  # Builds the Docker image and pushes it to the registry
  # ------------------------------------------------
  build-and-push:
    runs-on: ubuntu-latest
    steps:
      - name: üì• Checkout Code
        uses: actions/checkout@v4

      - name: üê≥ Login to Docker Hub
        uses: docker/login-action@v3
        with:
          # Use secrets defined in GitHub repository settings
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: üèóÔ∏è Build and Push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          # The image tag for the final container
          tags: |
            ${{ secrets.DOCKERHUB_USERNAME }}/astro-app:latest
            ${{ secrets.DOCKERHUB_USERNAME }}/astro-app:${{ github.sha }}

  # ------------------------------------------------
  # JOB 2: Continuous Deployment (CD)
  # Deploys the new image via SSH on the Linux server
  # ------------------------------------------------
  deploy:
    needs: build-and-push # Ensures this job starts only after a successful build
    runs-on: ubuntu-latest
    steps:
      - name: üíª Deploy new Docker image via SSH
        uses: appleboy/ssh-action@v1.0.1
        with:
          # SSH connection secrets
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_KEY }}

          # Commands to execute on your Linux server:
          script: |
            IMAGE_TAG=${{ secrets.DOCKERHUB_USERNAME }}/astro-app:${{ github.sha }}
            IMAGE_TAG_LATEST=${{ secrets.DOCKERHUB_USERNAME }}/astro-app:latest
            LIVE_CONTAINER_NAME=astro_website_live
            NEW_CONTAINER_NAME=astro_website_staging

            # üí° FINAL PORT: The application runs here
            LIVE_PORT=4321
            # üí° TEMPORARY PORT: Used for the health check
            STAGING_PORT=4322 

            echo "0. Logging into Docker Hub..."
            echo "${{ secrets.DOCKERHUB_TOKEN }}" | docker login -u "${{ secrets.DOCKERHUB_USERNAME }}" --password-stdin

            echo "1. Pulling new image from Docker Hub..."
            # Use SHA-specific tag to ensure we get the exact new build
            docker pull $IMAGE_TAG
            # Also pull latest for reference
            docker pull $IMAGE_TAG_LATEST

            echo "2. Starting new container alongside the old one on port $STAGING_PORT..."
            # Start the new container on the staging port using SHA-specific tag
            docker run -d \
              --name $NEW_CONTAINER_NAME \
              -p $STAGING_PORT:80 \
              --restart on-failure \
              $IMAGE_TAG

            echo "3. Health check - waiting for new container to be ready..."
            # Wait for container to be healthy (pinging the container via the staging port on the host)
            sleep 10
            if ! wget --spider -q http://localhost:$STAGING_PORT; then
              echo "‚ùå Health check failed on port $STAGING_PORT! Rolling back..."
              docker stop $NEW_CONTAINER_NAME || true
              docker rm $NEW_CONTAINER_NAME || true
              exit 1
            fi
            echo "‚úÖ Health check passed!"

            echo "4. Switching to new container (zero-downtime attempt)..."

            # --- Stop/Remove Old Container (Frees up port 4321) ---
            echo "   Stopping and removing old container ($LIVE_CONTAINER_NAME)..."
            docker stop $LIVE_CONTAINER_NAME || true
            docker rm $LIVE_CONTAINER_NAME || true

            # --- Rerun Staging Container on Live Port (4321) and Rename ---
            # Stop the temporary container (to free up $STAGING_PORT)
            docker stop $NEW_CONTAINER_NAME
            docker rm $NEW_CONTAINER_NAME

            # Start the container again, now using the final LIVE_PORT (4321:80) with SHA-specific tag
            docker run -d \
              --name $LIVE_CONTAINER_NAME \
              -p $LIVE_PORT:80 \
              --restart always \
              $IMAGE_TAG

            echo "5. Cleaning up old Docker images..."
            docker image prune -af --filter "until=24h"

            echo "6. Logging out from Docker Hub..."
            docker logout

            echo "‚úÖ Deployment finished successfully!"
            echo "üì¶ Deployed image: $IMAGE_TAG"
